name: CI Pipeline

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]

jobs:
  # JOB 1: Lint & format checks
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install linters
        run: |
          python -m pip install --upgrade pip
          pip install ruff black isort sqlfluff

      - name: Run linters (dont fail CI for now â€” toggle as desired)
        run: |
          ruff check .
          black --check .
          sqlfluff lint banking/models/ --dialect snowflake

  # JOB 2: Python unit tests (optional)
  python-tests:
    runs-on: ubuntu-latest
    needs: [code-quality]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install test deps
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
          pip install -r requirements.txt || echo "No top-level requirements"
          pip install -r data-generator/requirements.txt || echo "No data-generator requirements"
          pip install -r consumer/requirements.txt || echo "No consumer requirements"

      - name: Run tests (non-blocking)
        run: |
          pytest tests/ --maxfail=1 --disable-warnings || echo "Tests failed or no tests"

  # JOB 3: dbt validation (compile/parse)
  dbt-validation:
    runs-on: ubuntu-latest
    needs: [python-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dbt (matches local)
        run: |
          python -m pip install --upgrade pip
          pip install "dbt-core==1.10.15" "dbt-snowflake==1.10.3"

      - name: Prepare dbt profile (uses secrets)
        run: |
          mkdir -p ~/.dbt
          cat > ~/.dbt/profiles.yml <<EOL
banking:
  target: dev
  outputs:
    dev:
      type: snowflake
      account: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      user: ${{ secrets.SNOWFLAKE_USER }}
      password: ${{ secrets.SNOWFLAKE_PASSWORD }}
      role: ACCOUNTADMIN
      database: banking
      warehouse: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
      schema: analytics
      threads: 4
EOL

      - name: dbt deps (if using packages)
        run: |
          cd banking || exit 0
          dbt deps || echo "No dbt packages"

      - name: dbt compile & parse
        run: |
          cd banking
          dbt compile --profiles-dir ~/.dbt
          dbt parse --profiles-dir ~/.dbt

  # JOB 4: Docker build test (quick validation that Dockerfile works)
  docker-build:
    runs-on: ubuntu-latest
    needs: [dbt-validation]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Airflow image (test)
        run: |
          docker build -f dockerfile-airflow.dockerfile -t airflow-test:ci .
      
      - name: Verify dbt is present in image
        run: |
          docker run --rm airflow-test:ci dbt --version
